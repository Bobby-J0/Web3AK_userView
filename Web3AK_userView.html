<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web3AK ì¡°ì§ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script>
    if (typeof Object.assign !== 'function') {
      Object.defineProperty(Object, "assign", {
        value: function assign(target, varArgs) {
          'use strict';
          if (target === null || target === undefined) {
            throw new TypeError('Cannot convert undefined or null to object');
          }

          var to = Object(target);

          for (var index = 1; index < arguments.length; index++) {
            var nextSource = arguments[index];

            if (nextSource !== null && nextSource !== undefined) {
              for (var nextKey in nextSource) {
                if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
                  to[nextKey] = nextSource[nextKey];
                }
              }
            }
          }
          return to;
        },
        writable: true,
        configurable: true
      });
    }
    </script>
    
    <script src="https://unpkg.com/gojs@2.3.11/release/go.js"></script> 
    <style>
        /* (ìŠ¤íƒ€ì¼ ì‹œíŠ¸ ë‚´ìš©ì€ ì´ì „ê³¼ ë™ì¼í•©ë‹ˆë‹¤. ë³€ê²½ ì—†ìŒ) */
        #orgChartDiv { width: 100%; height: 85vh; background-color: #FAFAFA; border: 1px solid #ccc; }
        body { font-family: Arial, sans-serif; text-align: center; margin: 0; padding: 0; position: relative; }
        .node-info { position: absolute; top: 70px; left: 10px; max-width: 380px; text-align: left; padding: 15px; border: 1px solid #ddd; background-color: rgba(255, 255, 255, 0.95); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 100; }
        .feature-info { position: absolute; top: 95px; right: 40px; max-width: 400px; text-align: left; padding: 15px; border: 1px solid #ccc; background-color: rgba(255, 255, 255, 0.95); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 100; font-size: 13px; display: none; }
        .feature-info.active { display: block; }
        .search-container { margin-top: 15px; margin-bottom: 15px; text-align: center; }
        #searchInput { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 300px; }
        .search-container button { padding: 8px 15px; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px; }
        #featureToggleButton { background-color: #f8f9fa; color: #212529; border: 1px solid #ccc; }
        #clearSearchButton { background-color: #6c757d; }
        #searchButton { background-color: #007bff; }
        #searchButton:hover { background-color: #0056b3; }
        #clearSearchButton:hover { background-color: #5a6268; }
        #featureToggleButton:hover { background-color: #e2e6ea; }
    </style>
</head>
<body>
    <h2>Web3AK ì¡°ì§ë„</h2>
    
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="ì´ë¦„, ì—°ë½ì²˜, ì§€ê°‘ì£¼ì†Œ (ë¶€ë¶„ ì¼ì¹˜ ê²€ìƒ‰)">
        <div class="button-row">
            <button id="featureToggleButton">ê¸°ëŠ¥</button>
            <button id="clearSearchButton">Clear</button>
            <button id="searchButton" onclick="highlightNodes()">ê²€ìƒ‰</button>
        </div>
    </div>

    <div class="feature-info" id="featureInfo">
        <h3>ğŸš€ ì›¹ ì•± í•µì‹¬ ê¸°ëŠ¥</h3>
        <ul>
            <li>**ë°ì´í„° ì—°ë™:** Google Sheets ë°ì´í„° ì‹¤ì‹œê°„ ìë™ ë°˜ì˜</li>
            <li>**ë…¸ë“œ ìƒì„¸:** í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ í‘œì‹œ</li>
            <li>**ê²€ìƒ‰:** ì´ë¦„/ì—°ë½ì²˜/ì§€ê°‘ì£¼ì†Œë¡œ ì…ë ¥ ì¦‰ì‹œ ë…¸ë“œ ìë™ ê°•ì¡° (ë¶€ë¶„ ì¼ì¹˜)</li>
            <li>**ê²€ìƒ‰ ì´ˆê¸°í™”:** ESC í‚¤ ë˜ëŠ” 'Clear' ë²„íŠ¼ìœ¼ë¡œ ê²€ìƒ‰ ì´ˆê¸°í™” ê°€ëŠ¥</li>
            <li>**ê¸°ë³¸ ì¡°ì‘:** ì¡°ì§ë„ ì´ë™ ë° í™•ëŒ€/ì¶•ì†Œ (í‚¤ë³´ë“œ + ë§ˆìš°ìŠ¤ íœ )</li>
        </ul>
    </div>

    <div class="node-info" id="selectedNodeInfo">ë…¸ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

    <div id="orgChartDiv"></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyiqN24ws77h9-DgeN3LkuEiK39azcSZXsS6_L8S_UvvcwUJmY0b-2wLK_xzKtmmNqRlQ/exec"; 
        
        if (typeof go === 'undefined') {
            document.getElementById("orgChartDiv").innerHTML = `<p style="color: red; padding: 20px;">**ì¹˜ëª…ì  ì˜¤ë¥˜:** GoJS ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜, ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ë¬¸ì œë¡œ ì¸í•´ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìµœì‹  ë¸Œë¼ìš°ì €ë¥¼ ì‚¬ìš©í•´ ë³´ì‹­ì‹œì˜¤.</p>`;
        } else {
            const $ = go.GraphObject.make; 
            let myDiagram = null; 
            
            function init() {
                myDiagram =
                    $(go.Diagram, "orgChartDiv", 
                    {
                        layout: $(go.TreeLayout, 
                                    { angle: 90, nodeSpacing: 10, layerSpacing: 50 }),
                        "undoManager.isEnabled": true, 
                        "click": function(e) {
                            document.getElementById("selectedNodeInfo").innerHTML = "ë…¸ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.";
                            closeFeatureInfo(e);
                        },
                        initialContentAlignment: go.Spot.TopCenter 
                    });

                // --- ë…¸ë“œ í…œí”Œë¦¿ ì •ì˜ ---
                myDiagram.nodeTemplate = 
                    $(go.Node, "Auto",
                        { selectionAdornmentTemplate: nodeSelectionAdornmentTemplate },
                        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                        {
                            click: function(e, node) {
                                showNodeDetails(node.data);
                                closeFeatureInfo(e); 
                            }
                        },
                        $(go.Shape, "RoundedRectangle",
                            { name: "shapeElement", strokeWidth: 2, stroke: "#224488" },
                            
                            // âœ… [í•µì‹¬ ìˆ˜ì •] 3. ofData() êµ¬ë¬¸ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤.
                            new go.Binding("fill", "isHighlighted", function(h, shape) {
                                if (h) return "#FF9933"; // ê²€ìƒ‰ ì‹œ ê°•ì¡° ìƒ‰ìƒ
                                // isRoot ì†ì„±ì„ ì‚¬ìš©í•˜ì—¬ ì›ë˜ì˜ ìƒ‰ìƒìœ¼ë¡œ ë³µêµ¬
                                return shape.part.data.isRoot ? "#ff9933" : "#66bb6a"; 
                            }) // <- ì—¬ê¸°ì— ofData()ê°€ ì—†ì–´ì•¼ í•©ë‹ˆë‹¤.
                        ),
                        
                        $(go.TextBlock, "Default Info",
                            { margin: 8, font: "bold 14pt Arial, sans-serif", stroke: "white", textAlign: "center" },
                            new go.Binding("text", "", function(data) {
                                const name = data.ìœ ì €_ì´ë¦„ || 'ì´ë¦„ ì—†ìŒ';
                                const userId = data.ìœ ì €_ID;
                                let totalCountLine = (data.ì´_í•˜ìœ„_ìˆ˜ && data.ì´_í•˜ìœ„_ìˆ˜ > 0) ? `\n(ì´ ${data.ì´_í•˜ìœ„_ìˆ˜}ëª…)` : "";
                                return `${name}\n${userId}${totalCountLine}`; 
                            })
                        )
                    );

                myDiagram.linkTemplate = 
                    $(go.Link, go.Link.Orthogonal, { corner: 5 },
                        $(go.Shape, { strokeWidth: 1.5, stroke: "#555" }));
                // --- ë…¸ë“œ í…œí”Œë¦¿ ì •ì˜ ë ---
                
                // ì¤‘ì•™ ì •ë ¬ ë¡œì§ (ì´ì „ê³¼ ë™ì¼, setViewportBounds ìœ ì§€)
                myDiagram.addDiagramListener("LayoutCompleted", function(e) {
                    const diagram = e.diagram;
                    const rootData = diagram.model.nodeDataArray.find(d => d.isRoot);
                    
                    if (rootData) {
                        const rootNode = diagram.findNodeForKey(rootData.key);
                        
                        if (rootNode) {
                            diagram.startTransaction("Initial Root Zoom");
                            
                            const initialGroup = new go.Set();
                            initialGroup.add(rootNode);
                            
                            rootNode.findTreeChildrenNodes().each(child => {
                                if (child.data.parent === rootNode.data.key) {
                                    initialGroup.add(child);
                                }
                            });
                            
                            if (initialGroup.count > 0) {
                                const bounds = diagram.computeBounds(initialGroup);
                                diagram.setViewportBounds(bounds, diagram.scale * 1.1);
                            } else {
                                const rootBounds = rootNode.actualBounds;
                                diagram.scrollToRect(rootBounds); 
                            }
                            
                            diagram.commitTransaction("Initial Root Zoom");
                        }
                    }
                });
                
                fetchDataAndBuildChart(myDiagram);
                
                // --- [JS ë¡œì§: ê²€ìƒ‰ ë° í† ê¸€ í†µí•© - ë³€ê²½ ì—†ìŒ] ---
                const searchInput = document.getElementById('searchInput');
                const clearButton = document.getElementById('clearSearchButton');
                const featureToggleButton = document.getElementById('featureToggleButton');
                const featureInfoDiv = document.getElementById('featureInfo');

                searchInput.addEventListener('keyup', highlightNodes); 

                function clearSearchAndUnhighlight() {
                    searchInput.value = '';
                    highlightNodes(); 
                }

                searchInput.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape' || event.keyCode === 27) {
                        event.preventDefault(); 
                        clearSearchAndUnhighlight();
                        closeFeatureInfo(); 
                    }
                });

                clearButton.addEventListener('click', function() {
                    clearSearchAndUnhighlight();
                    searchInput.focus();
                    closeFeatureInfo(); 
                });

                function closeFeatureInfo() {
                    featureInfoDiv.classList.remove('active');
                }

                featureToggleButton.addEventListener('click', function() {
                    featureInfoDiv.classList.toggle('active');
                });

                document.body.addEventListener('click', function(event) {
                    const target = event.target;
                    if (featureInfoDiv.contains(target) || target === featureToggleButton) {
                        return;
                    }
                    if (featureInfoDiv.classList.contains('active')) {
                        closeFeatureInfo();
                    }
                });
                // --- [JS ë¡œì§ í†µí•© ì¢…ë£Œ] ---
            }

            // ë°ì´í„° ë¡œë“œ ë° ê¸°íƒ€ í•¨ìˆ˜ (ë³€ê²½ ì—†ìŒ)
            function fetchDataAndBuildChart(diagram) {
                fetch(API_URL)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨: " + response.statusText);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const nodeDataArray = data.map(item => ({
                            key: item['ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ'], 
                            parent: item['ìƒìœ„_ë…¸ë“œ_ì§€ê°‘_ì£¼ì†Œ'], 
                            ìœ ì €_ì´ë¦„: item['ìœ ì €_ì´ë¦„'] || item['ìœ ì €_ID'],
                            ìœ ì €_ID: item['ìœ ì €_ID'],
                            ì—°ë½ì²˜: item['ì—°ë½ì²˜'],
                            ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ: item['ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ'],
                            ì§ì†_í•˜ìœ„_ìˆ˜: item['ì§ì†_í•˜ìœ„_ìˆ˜'],
                            ì´_í•˜ìœ„_ìˆ˜: item['ì´_í•˜ìœ„_ìˆ˜'],
                            isRoot: item['ìƒìœ„_ë…¸ë“œ_ì§€ê°‘_ì£¼ì†Œ'] === "", 
                            isHighlighted: false 
                        })).filter(item => item.key); 

                        diagram.model = $(go.TreeModel, { nodeDataArray: nodeDataArray });
                    })
                    .catch(error => {
                        console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                        document.getElementById("orgChartDiv").innerHTML = `<p style="color: red; padding: 20px;">**ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:** API URL(${API_URL})ì„ í™•ì¸í•˜ê±°ë‚˜, Apps Scriptê°€ "ëª¨ë“  ì‚¬ìš©ì"ì—ê²Œ ê³µê°œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. ${error.message}</p>`;
                    });
            }

            function showNodeDetails(data) {
                const detailsDiv = document.getElementById("selectedNodeInfo");
                detailsDiv.innerHTML = `
                    <h3>${data.ìœ ì €_ì´ë¦„} (${data.ìœ ì €_ID})</h3>
                    <p><strong>ë³¸ì¸ ì§€ê°‘:</strong> ${data.ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ}</p>
                    <p><strong>ìƒìœ„ ì§€ê°‘:</strong> ${data.parent || 'ì—†ìŒ (ë£¨íŠ¸)'}</p>
                    <p><strong>ì—°ë½ì²˜:</strong> ${data.ì—°ë½ì²˜}</p>
                    <p><strong>ì§ì† í•˜ìœ„:</strong> ${data.ì§ì†_í•˜ìœ„_ìˆ˜}ëª…, <strong>ì´ í•˜ìœ„ ì¡°ì§:</strong> ${data.ì´_í•˜ìœ„_ìˆ˜}ëª…</p>
                `;
            }
            
            function highlightNodes() {
                if (!myDiagram || !myDiagram.model) return;
                
                const searchInput = document.getElementById('searchInput');
                const searchText = searchInput.value.toLowerCase().trim();
                const model = myDiagram.model;
                let firstFoundNode = null; 

                myDiagram.startTransaction("highlight search results");

                model.nodeDataArray.forEach(data => {
                    const name = (data.ìœ ì €_ì´ë¦„ || '').toLowerCase();
                    const userId = (data.ìœ ì €_ID || '').toLowerCase();
                    const contact = (data.ì—°ë½ì²˜ || '').toLowerCase();
                    const wallet = (data.ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ || '').toLowerCase();
                    
                    let matches = false;

                    if (searchText.length > 0) {
                        if (name.includes(searchText) || userId.includes(searchText) || contact.includes(searchText) || wallet.includes(searchText)) {
                            matches = true;
                        }
                    }
                    
                    if (data.isHighlighted !== matches) {
                        model.setDataProperty(data, "isHighlighted", matches);
                    }
                    
                    if (matches && !firstFoundNode) {
                        firstFoundNode = myDiagram.findNodeForKey(data.key);
                    }
                });
                
                myDiagram.commitTransaction("highlight search results");
                
                if (firstFoundNode) {
                    if (firstFoundNode.actualBounds) {
                        myDiagram.scrollToRect(firstFoundNode.actualBounds);
                    }
                    firstFoundNode.isSelected = true;
                    showNodeDetails(firstFoundNode.data);
                } else {
                    myDiagram.clearSelection();
                    document.getElementById("selectedNodeInfo").innerHTML = "ë…¸ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.";
                }
            }

            const nodeSelectionAdornmentTemplate =
                $(go.Adornment, "Auto",
                    $(go.Shape, "RoundedRectangle",
                        { fill: null, stroke: "dodgerblue", strokeWidth: 3 }),
                    $(go.Placeholder)
                );

            window.addEventListener('DOMContentLoaded', init);
        }
    </script>
</body>
</html>
