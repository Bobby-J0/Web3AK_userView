<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web3AK ìœ ì € ì¡°ì§ë„ ë·°ì–´ (ì‹¤ì‹œê°„ ë§ˆì¸ë“œë§µ í˜•ì‹)</title>
    <script src="https://unpkg.com/gojs@2.3.11/release/go.js"></script>
    <style>
        #orgChartDiv {
            width: 100%;
            height: 85vh; 
            background-color: #FAFAFA;
            border: 1px solid #ccc;
        }
        body { 
            font-family: Arial, sans-serif; 
            text-align: center;
            margin: 0; 
            padding: 0;
            position: relative; 
        }
        .node-info { 
            position: absolute; 
            top: 60px; 
            right: 40px;
            max-width: 380px; 
            text-align: left; 
            
            padding: 15px; 
            border: 1px solid #ddd; 
            background-color: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 100; 
        }
        
        /* âœ… ìƒˆë¡œ ì¶”ê°€ëœ ê¸°ëŠ¥ ì•ˆë‚´ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .feature-info {
            position: absolute; 
            top: 60px; 
            left: 15px; 
            max-width: 380px; 
            text-align: left; 
            
            padding: 15px; 
            border: 1px solid #ccc; 
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
            
            font-size: 13px;
        }
        .feature-info ul {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 0;
        }
        .feature-info li {
            margin-bottom: 5px;
        }
        
    </style>
</head>
<body>
    <h2>Web3 ìœ ì € ì¡°ì§ë„ (ì‹¤ì‹œê°„ ë§ˆì¸ë“œë§µ ë·°)</h2>
    
    <div class="feature-info">
        <h3>ğŸš€ ì›¹ ì•± í•µì‹¬ ê¸°ëŠ¥</h3>
        <ul>
            <li>**ë°ì´í„° ì—°ë™:** Google Sheets ë°ì´í„° ì‹¤ì‹œê°„ ìë™ ë°˜ì˜</li>
            <li>**ë…¸ë“œ ìƒì„¸:** í´ë¦­ ì‹œ ìš°ì¸¡ ìƒë‹¨ì— ì§€ê°‘ ì£¼ì†Œ ë“± ìƒì„¸ ì •ë³´ í‘œì‹œ</li>
            <li>**ê¸°ë³¸ ì¡°ì‘:** ì¡°ì§ë„ í™•ëŒ€/ì¶•ì†Œ ë° ì´ë™</li>
        </ul>
    </div>

    <div class="node-info" id="selectedNodeInfo">ë…¸ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

    <div id="orgChartDiv"></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyiqN24ws77h9-DgeN3LkuEiK39azcSZXsS6_L8S_UvvcwUJmY0b-2wLK_xzKtmmNqRlQ/exec"; 

        const $ = go.GraphObject.make; 

        function init() {
            const myDiagram =
                $(go.Diagram, "orgChartDiv", 
                {
                    initialAutoScale: go.Diagram.Uniform,
                    layout: $(go.TreeLayout,
                                { angle: 90, nodeSpacing: 10, layerSpacing: 50 }),
                    "undoManager.isEnabled": true,
                    "click": function(e) {
                        document.getElementById("selectedNodeInfo").innerHTML = "ë…¸ë“œë¥¼ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.";
                    }
                });

    myDiagram.nodeTemplate = 
        $(go.Node, "Auto",
            { selectionAdornmentTemplate: nodeSelectionAdornmentTemplate },
            new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
            {
                click: function(e, node) {
                    showNodeDetails(node.data);
                }
            },
            $(go.Shape, "RoundedRectangle",
                { fill: "#3366cc", stroke: "#224488", strokeWidth: 2 },
                new go.Binding("fill", "isRoot", function(isRoot) { return isRoot ? "#ff9933" : "#66bb6a"; })),
            
            $(go.TextBlock, "Default Info",
                { 
                    margin: 8, 
                    font: "bold 14pt Arial, sans-serif",
                    stroke: "white", 
                    textAlign: "center" 
                },
                new go.Binding("text", "", function(data) {
                    const name = data.ìœ ì €_ì´ë¦„ || 'ì´ë¦„ ì—†ìŒ';
                    const userId = data.ìœ ì €_ID;
                    
                    let totalCountLine = "";
                    if (data.ì´_í•˜ìœ„_ìˆ˜ && data.ì´_í•˜ìœ„_ìˆ˜ > 0) {
                        totalCountLine = `\n(ì´ ${data.ì´_í•˜ìœ„_ìˆ˜}ëª…)`;
                    }

                    return `${name}\n${userId}${totalCountLine}`; 
                })
            )
        );

            myDiagram.linkTemplate = 
                $(go.Link, go.Link.Orthogonal, { corner: 5 },
                    $(go.Shape, { strokeWidth: 1.5, stroke: "#555" }));
            
            fetchDataAndBuildChart(myDiagram);
        }

        function fetchDataAndBuildChart(diagram) {
            fetch(API_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error("API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    }
                    
                    const nodeDataArray = data.map(item => ({
                        key: item['ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ'], 
                        parent: item['ìƒìœ„_ë…¸ë“œ_ì§€ê°‘_ì£¼ì†Œ'], 
                        ìœ ì €_ì´ë¦„: item['ìœ ì €_ì´ë¦„'] || item['ìœ ì €_ID'],
                        ìœ ì €_ID: item['ìœ ì €_ID'],
                        ì—°ë½ì²˜: item['ì—°ë½ì²˜'],
                        ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ: item['ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ'],
                        ì§ì†_í•˜ìœ„_ìˆ˜: item['ì§ì†_í•˜ìœ„_ìˆ˜'],
                        ì´_í•˜ìœ„_ìˆ˜: item['ì´_í•˜ìœ„_ìˆ˜'],
                        isRoot: item['ìƒìœ„_ë…¸ë“œ_ì§€ê°‘_ì£¼ì†Œ'] === "" 
                    })).filter(item => item.key); 

                    diagram.model = $(go.TreeModel, { nodeDataArray: nodeDataArray });
                })
                .catch(error => {
                    console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    document.getElementById("orgChartDiv").innerHTML = `<p style="color: red;">ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: API URL(${API_URL})ì„ í™•ì¸í•˜ê±°ë‚˜, Apps Scriptê°€ "ëª¨ë“  ì‚¬ìš©ì"ì—ê²Œ ê³µê°œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. ${error.message}</p>`;
                });
        }

        function showNodeDetails(data) {
            const detailsDiv = document.getElementById("selectedNodeInfo");
            detailsDiv.innerHTML = `
                <h3>${data.ìœ ì €_ì´ë¦„} (${data.ìœ ì €_ID})</h3>
                <p><strong>ë³¸ì¸ ì§€ê°‘:</strong> ${data.ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ}</p>
                <p><strong>ìƒìœ„ ì§€ê°‘:</strong> ${data.parent || 'ì—†ìŒ (ë£¨íŠ¸)'}</p>
                <p><strong>ì—°ë½ì²˜:</strong> ${data.ì—°ë½ì²˜}</p>
                <p><strong>ì§ì† í•˜ìœ„:</strong> ${data.ì§ì†_í•˜ìœ„_ìˆ˜}ëª…, <strong>ì´ í•˜ìœ„ ì¡°ì§:</strong> ${data.ì´_í•˜ìœ„_ìˆ˜}ëª…</p>
            `;
        }

        const nodeSelectionAdornmentTemplate =
            $(go.Adornment, "Auto",
                $(go.Shape, "RoundedRectangle",
                    { fill: null, stroke: "dodgerblue", strokeWidth: 3 }),
                $(go.Placeholder)
            );

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>