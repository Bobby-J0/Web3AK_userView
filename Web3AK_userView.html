<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Web3AK</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script>
    if (typeof Object.assign !== 'function') {
      Object.defineProperty(Object, "assign", {
        value: function assign(target, varArgs) {
          'use strict';
          if (target === null || target === undefined) {
            throw new TypeError('Cannot convert undefined or null to object');
          }

          var to = Object(target);

          for (var index = 1; index < arguments.length; index++) {
            var nextSource = arguments[index];

            if (nextSource !== null && nextSource !== undefined) {
              for (var nextKey in nextSource) {
                if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
                  to[nextKey] = nextKey;
                }
              }
            }
          }
          return to;
        },
        writable: true,
        configurable: true
      });
    }
    </script>
    
    <script src="https://unpkg.com/gojs@2.3.11/release/go.js"></script>
    
    <style>
        /* ======================================================= */
        /* [1] ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° ë·°ì–´ ìŠ¤íƒ€ì¼ */
        /* ======================================================= */
        #orgChartDiv {
            width: 100%;
            height: 85vh; 
            background-color: #FAFAFA; 
            border: 1px solid #ccc;
        }
        body { 
            font-family: Arial, sans-serif; 
            text-align: center;
            margin: 0; 
            padding: 0;
            position: relative; 
        }
        
        /* ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ í‘œì‹œë˜ëŠ” ê²½ê³  ë©”ì‹œì§€ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        #warningMessage {
            background-color: #ffcdd2; 
            color: #d32f2f; 
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-weight: bold;
            display: none; 
        }
        
        /* ì¡°ì§ë„ ì „ì²´ ë³´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #showAllButton {
            background-color: #17a2b8; 
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none; 
        }

        /* [2] ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        #loadingSpinner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 1000; background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 20px 40px; border-radius: 8px; font-size: 1.2em; display: none;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff; border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* [3] ê¸°íƒ€ UI ìŠ¤íƒ€ì¼ (ì›¹/ë°ìŠ¤í¬í†± ê¸°ë³¸ ë ˆì´ì•„ì›ƒ) */
        
        /* ìƒì„¸ ì •ë³´ ë°•ìŠ¤: ì›¹ì—ì„œëŠ” ì¢Œì¸¡ ìƒë‹¨ì— ê³ ì • */
        .node-info { 
            position: absolute; 
            top: 95px; 
            left: 10px; 
            right: auto; 
            max-width: 380px; text-align: left; padding: 15px; 
            border: 1px solid #ddd; background-color: rgba(255, 255, 255, 0.95); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            z-index: 100; transition: all 0.3s ease; 
        }
        .node-info button { 
            background-color: #ff6f61; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 4px; margin-top: 10px;
        }
        
        /* ê¸°ëŠ¥ ì•ˆë‚´ ë°•ìŠ¤: ì›¹ì—ì„œëŠ” ìš°ì¸¡ ìƒë‹¨ì— ê³ ì • */
        .feature-info {
            position: absolute; 
            top: 95px; 
            right: 40px; 
            left: auto; 
            max-width: 400px; text-align: left; padding: 15px; 
            border: 1px solid #ccc; background-color: rgba(255, 255, 255, 0.95); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 100; font-size: 13px; transition: all 0.3s ease; 
            display: none; 
        }
        .feature-info ul {
            list-style-type: none; padding-left: 0; margin-bottom: 0;
        }
        .feature-info li {
            margin-bottom: 5px;
        }

        /* ê²€ìƒ‰ì°½ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .search-container {
            margin-top: 15px; margin-bottom: 15px; text-align: center;
        }
        #searchInput {
            padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 300px; 
        }
        .search-container button, .mobile-toggle-button {
            padding: 8px 15px; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px; 
        }
        .search-container button:not(#clearSearchButton):not(.mobile-toggle-button) {
             background-color: #007bff;
        }
        #clearSearchButton {
            background-color: #6c757d; 
        }
        #toggleFeatureButton {
            background-color: #28a745; 
        }

        /* ======================================================= */
        /* [4] ëª¨ë°”ì¼ ìµœì í™” (@media ì¿¼ë¦¬ - 600px ì´í•˜) */
        /* ======================================================= */
        @media (max-width: 600px) {
            #orgChartDiv { height: 85vh; }
            
            /* ê²€ìƒ‰ ì˜ì—­ ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ì¡°ì • */
            .search-container {
                margin-top: 10px; margin-bottom: 5px; padding: 0 10px; 
                display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center;
            }
            #searchInput {
                width: 100%; margin-bottom: 5px; order: 1; 
            }
            #clearSearchButton, 
            .search-container button:not(#clearSearchButton):not(#toggleFeatureButton),
            #toggleFeatureButton {
                width: 32%; display: inline-block; box-sizing: border-box; margin-left: 0; margin-right: 0; order: 2; 
            }
            #clearSearchButton { margin-right: 2%; }
            .search-container button:not(#clearSearchButton):not(#toggleFeatureButton) { margin-right: 2%; }
            .mobile-toggle-group { display: none; }
            
            /* ê¸°ëŠ¥ ì•ˆë‚´ ë°•ìŠ¤ (ëª¨ë°”ì¼: í•˜ë‹¨ ê³ ì •) */
            .feature-info { 
                position: fixed; 
                bottom: 10px; 
                top: auto; 
                left: 10px; 
                right: 10px;
                max-width: none; 
                width: auto;
                padding: 15px;
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); 
                border: 1px solid #b3e5fc; 
                background-color: rgba(255, 255, 255, 0.98); 
                z-index: 101; 
                font-size: 13px; 
                border-radius: 8px;
            }
            
            /* ìƒì„¸ ì •ë³´ ë°•ìŠ¤ (ëª¨ë°”ì¼: ìƒë‹¨ ê³ ì •) */
            .node-info { 
                position: fixed; 
                top: 115px; 
                bottom: auto; 
                left: 10px;
                right: 10px;
                max-width: none;
                padding: 15px;
                background-color: rgba(255, 255, 255, 0.98);
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
                z-index: 100;
                border: 1px solid #ccc;
                border-radius: 8px;
            }
        }
    </style>
</head>
<body>
    <h2>Web3AK ì¡°ì§ë„</h2>
    
    <div id="warningMessage"></div>
    
    <button id="showAllButton" onclick="showAll()">ğŸ”™ ì „ì²´ ì¡°ì§ë„ ë³´ê¸°</button>

    <div class="search-container">
        <input type="text" id="searchInput" placeholder="ì´ë¦„, ì—°ë½ì²˜, ì§€ê°‘ì£¼ì†Œ (ë¶€ë¶„ ì¼ì¹˜ ê²€ìƒ‰)">
        <button id="clearSearchButton">Clear</button>
        <button onclick="highlightNodes()">ê²€ìƒ‰</button>
        <button id="toggleFeatureButton" class="mobile-toggle-button" onclick="toggleFeatureInfo()">ê¸°ëŠ¥ ì•ˆë‚´</button> 
    </div>
    
    <div class="feature-info" id="featureInfo" onclick="event.stopPropagation()">
        <h3>ğŸš€ í•µì‹¬ ê¸°ëŠ¥ ìš”ì•½</h3>
        <ul>
            <li>**ë°ì´í„° ê°±ì‹ :** Google Sheets ë³€ê²½ ì‹œ **í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨** í•„ìˆ˜</li>
            <li>**ìƒì„¸ ì •ë³´:** ë…¸ë“œ **í´ë¦­**ìœ¼ë¡œ ì¢Œì¸¡ ì •ë³´ í™•ì¸</li>
            <li>**í•˜ìœ„ ì¡°ì§:** ìƒì„¸ ì •ë³´ ë°•ìŠ¤ì—ì„œ **í•˜ìœ„ì¡°ì§ë§Œ ë³´ê¸° ì„ íƒ**, ìƒë‹¨ **ì „ì²´ë³´ê¸°** íƒ­ í™œì„±</li>
            <li>**ì‹œìŠ¤í…œ ì§„ë‹¨:** ë°ì´í„° ìœ íš¨ì„±(Key/Parent) ìë™ ê²€ì¦</li>
        </ul>
    </div>

    <div class="node-info" id="selectedNodeInfo">ë…¸ë“œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

    <div id="loadingSpinner">
        <div class="spinner"></div>
        ë°ì´í„° ë¡œë“œ ì¤‘...
    </div>

    <div id="orgChartDiv"></div>

    <script>
        /* ======================================================= */
        /* [1] ì „ì—­ ë³€ìˆ˜ ë° ìƒìˆ˜ ì •ì˜ */
        /* ======================================================= */
        
        // Google Apps Script API ì—”ë“œí¬ì¸íŠ¸
        const API_URL = "https://script.google.com/macros/s/AKfycbyiqN24ws77h9-DgeN3LkuEiK39azcSZXsS6_L8S_UvvcwUJmY0b-2wLK_xzKtmmNqRlQ/exec"; 
        const $ = go.GraphObject.make; 
        
        let myDiagram = null;           // GoJS ë‹¤ì´ì–´ê·¸ë¨ ê°ì²´
        let allNodeData = [];           // APIì—ì„œ ë¡œë“œëœ ì „ì²´ ë…¸ë“œ ë°ì´í„° ì €ì¥
        let isSubtreeView = false;      // í˜„ì¬ ì„œë¸ŒíŠ¸ë¦¬ ë³´ê¸° ëª¨ë“œì¸ì§€ ì—¬ë¶€
        let currentSubtreeRootKey = null; // í˜„ì¬ ì„œë¸ŒíŠ¸ë¦¬ ë·°ì˜ ë£¨íŠ¸ ë…¸ë“œ Key

        // UI ìš”ì†Œ DOM ìºì‹±
        const featureInfoDiv = document.getElementById('featureInfo');
        const selectedNodeInfoDiv = document.getElementById('selectedNodeInfo');
        const toggleFeatureButton = document.getElementById('toggleFeatureButton');
        const showAllButton = document.getElementById('showAllButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const warningMessageDiv = document.getElementById('warningMessage'); 
        
        /* ======================================================= */
        /* [2] UI ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ */
        /* ======================================================= */

        // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ/ìˆ¨ê¹€
        function showLoadingSpinner(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }
        
        // ë°ì´í„° ê²½ê³  ë©”ì‹œì§€ í‘œì‹œ/ìˆ¨ê¹€
        function showWarningMessage(message) {
            if (message) {
                warningMessageDiv.innerHTML = `âš ï¸ **ë°ì´í„° ê²½ê³ :** ${message}`;
                warningMessageDiv.style.display = 'block';
            } else {
                warningMessageDiv.style.display = 'none';
            }
        }
        
        // ê¸°ëŠ¥ ì•ˆë‚´ ë°•ìŠ¤ í† ê¸€ (ëª¨ë°”ì¼/ì›¹ ê³µí†µ)
        function toggleFeatureInfo() {
            if (selectedNodeInfoDiv.style.display === 'block') {
                 clearNodeInfo();
            }
            
            if (featureInfoDiv.style.display === 'none' || featureInfoDiv.style.display === '') {
                featureInfoDiv.style.display = 'block';
                toggleFeatureButton.style.backgroundColor = '#dc3545'; // ì—´ë¦¼: ë¹¨ê°•
            } else {
                featureInfoDiv.style.display = 'none';
                toggleFeatureButton.style.backgroundColor = '#28a745'; // ë‹«í˜: ë…¹ìƒ‰
            }
        }
        
        // ìƒì„¸ ì •ë³´ ë°•ìŠ¤ í‘œì‹œ (ëª¨ë°”ì¼ì—ì„œë§Œ í•„ìš”í•˜ë©° ì›¹ì—ì„œëŠ” í•­ìƒ í‘œì‹œ ìƒíƒœë¡œ CSSì—ì„œ ì œì–´)
        function showNodeInfo() {
            if (window.innerWidth <= 600) {
                selectedNodeInfoDiv.style.display = 'block';
                // ìƒì„¸ ì •ë³´ í‘œì‹œ ì‹œ, ê¸°ëŠ¥ ì•ˆë‚´ ë°•ìŠ¤ëŠ” ìˆ¨ê¹€
                if (featureInfoDiv.style.display === 'block') {
                    featureInfoDiv.style.display = 'none'; 
                    toggleFeatureButton.style.backgroundColor = '#28a745'; 
                }
            }
        }
        
        // ìƒì„¸ ì •ë³´ ë°•ìŠ¤ ë‚´ìš© ì´ˆê¸°í™” ë° ìˆ¨ê¹€ (ëª¨ë°”ì¼)
        function clearNodeInfo() {
             if (window.innerWidth <= 600) {
                selectedNodeInfoDiv.style.display = 'none'; 
            }
            selectedNodeInfoDiv.innerHTML = "ë…¸ë“œë¥¼ ì„ íƒí•˜ê±°ë‚˜ ê²€ìƒ‰í•˜ë©´ ìƒì„¸ ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤.";
        }

        /* ======================================================= */
        /* [3] ë°ì´í„° ìœ íš¨ì„± ë° ì°¨íŠ¸ ê´€ë¦¬ ë¡œì§ */
        /* ======================================================= */

        // ë…¸ë“œ ë°ì´í„°ì˜ Key ë° Parent ìœ íš¨ì„± ê²€ì‚¬
        function validateNodeData(dataArray) {
            const keys = new Set(dataArray.map(d => d.key));
            const invalidNodes = [];
            
            dataArray.forEach(data => {
                if (!data.key || data.key === "") {
                    invalidNodes.push(`[Key ëˆ„ë½] ì´ë¦„: ${data.ìœ ì €_ì´ë¦„ || 'ë¯¸ì •'}`);
                } else if (data.parent && data.parent !== "" && !keys.has(data.parent)) {
                    invalidNodes.push(`[ìœ ë ¹ Parent] Key: ${data.key}, Parent: ${data.parent}`);
                }
            });
            
            if (invalidNodes.length > 0) {
                return `ì¡°ì§ë„ì— ${invalidNodes.length}ê°œì˜ ë°ì´í„° ì˜¤ë¥˜ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì²« 3ê°œ í•­ëª©: ${invalidNodes.slice(0, 3).join(', ')}...`;
            }
            return null; 
        }

        // GoJS ëª¨ë¸ì„ ìƒˆ ë°ì´í„°ë¡œ ë¹Œë“œí•˜ê³  ì‹œì (Position/Scale)ì„ ë³µì›/ì´ˆê¸°í™”
        function buildChart(dataArray, isInitialLoad) {
            let oldPosition = null;
            let oldScale = null;
            
            // ìµœì´ˆ ë¡œë“œê°€ ì•„ë‹ ë•Œ (ì¦‰, ì„œë¸ŒíŠ¸ë¦¬ ì „í™˜ ë“± ì‹œì  ë³µì›ì´ í•„ìš”í•œ ê²½ìš°) í˜„ì¬ ì‹œì  ì €ì¥
            if (!isInitialLoad && myDiagram) {
                oldPosition = myDiagram.position.copy();
                oldScale = myDiagram.scale;
            }
            
            // GoJS ëª¨ë¸ ì—…ë°ì´íŠ¸ (ìƒˆ ë°ì´í„° ë°”ì¸ë”©)
            myDiagram.model = $(go.TreeModel, { 
                nodeDataArray: dataArray,
                nodeParentKeyProperty: "parent" 
            });
            
            // ì €ì¥ëœ ì‹œì  ë³µì›
            if (oldPosition !== null && oldScale !== null) {
                myDiagram.startTransaction("restore view");
                myDiagram.position = oldPosition;
                myDiagram.scale = oldScale;
                myDiagram.commitTransaction("restore view");
            } else {
                // ìµœì´ˆ ë¡œë“œ ì‹œ, ê¸°ë³¸ ìœ„ì¹˜/ìŠ¤ì¼€ì¼ ì„¤ì •
                myDiagram.initialPosition = new go.Point(0, 0); 
                myDiagram.scale = 1; 
            }
            
            myDiagram.requestUpdate(); 
            showLoadingSpinner(false); 
        }

        // íŠ¹ì • ë…¸ë“œë¥¼ ë£¨íŠ¸ë¡œ í•˜ëŠ” í•˜ìœ„ ì¡°ì§ë„(ì„œë¸ŒíŠ¸ë¦¬)ë§Œ í‘œì‹œ
        function showSubtree(rootKey) {
            currentSubtreeRootKey = rootKey; 
            isSubtreeView = true;
            
            const nodeMap = new Map();
            allNodeData.forEach(data => nodeMap.set(data.key, data));

            const subtreeKeys = new Set();
            const queue = [rootKey]; 

            // ë„ˆë¹„ ìš°ì„  íƒìƒ‰(BFS)ìœ¼ë¡œ í•˜ìœ„ ë…¸ë“œ í‚¤ë¥¼ ìˆ˜ì§‘
            let head = 0;
            while (head < queue.length) {
                const currentKey = queue[head++];
                subtreeKeys.add(currentKey);
                
                const children = allNodeData.filter(data => data.parent === currentKey).map(data => data.key);
                children.forEach(key => queue.push(key));
            }

            const newArray = [];
            const rootNodeData = nodeMap.get(rootKey);
            
            // ìƒˆ ëª¨ë¸ ë°°ì—´ ìƒì„±
            if (rootNodeData) {
                // ì„œë¸ŒíŠ¸ë¦¬ì˜ ë£¨íŠ¸ ë…¸ë“œëŠ” parentë¥¼ ì œê±°í•˜ì—¬ ìƒˆë¡œìš´ íŠ¸ë¦¬ì˜ ìµœìƒìœ„ë¡œ ì„¤ì •
                newArray.push({
                    ...rootNodeData, 
                    parent: undefined, 
                    isRoot: true 
                });
            }

            allNodeData.forEach(data => {
                if (data.key !== rootNodeData && subtreeKeys.has(data.key)) {
                    newArray.push({ ...data, isRoot: false }); 
                }
            });
            
            if (newArray.length > 0) {
                // ì„œë¸ŒíŠ¸ë¦¬ ì „í™˜ ì‹œì—ëŠ” ì‹œì  ë³µì› ì—†ì´ ì´ˆê¸°í™” ë ˆì´ì•„ì›ƒ (false)
                buildChart(newArray, false); 
                showAllButton.style.display = 'inline-block'; 
                clearNodeInfo(); 
            } else {
                isSubtreeView = false; 
            }
        }

        // ì „ì²´ ì¡°ì§ë„ë¡œ ë³µê·€
        function showAll() {
            if (allNodeData.length > 0) {
                isSubtreeView = false;
                currentSubtreeRootKey = null; 
                // ì „ì²´ ë³´ê¸°ë¡œ ì „í™˜ ì‹œì—ëŠ” ì‹œì  ë³µì› ì—†ì´ ì´ˆê¸°í™” ë ˆì´ì•„ì›ƒ (false)
                buildChart(allNodeData, false); 
                showAllButton.style.display = 'none'; 
                clearNodeInfo();
            }
        }

        /**
         * APIì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ì°¨íŠ¸ë¥¼ ë¹Œë“œí•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * (ìë™ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ì€ ì œê±°ë˜ì—ˆìœ¼ë©°, í˜ì´ì§€ ë¡œë“œ ì‹œ 1íšŒë§Œ í˜¸ì¶œë©ë‹ˆë‹¤)
         * @param {go.Diagram} diagram í˜„ì¬ ë‹¤ì´ì–´ê·¸ë¨ ê°ì²´
         * @param {boolean} isInitialLoad ìµœì´ˆ ë¡œë“œì¸ì§€ ì—¬ë¶€ (í•­ìƒ true)
         */
        function fetchDataAndBuildChart(diagram, isInitialLoad) {
            showLoadingSpinner(true); 
            showWarningMessage(null); 

            fetch(API_URL)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("API í˜¸ì¶œ ì‹¤íŒ¨: " + response.statusText);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!Array.isArray(data)) {
                        throw new Error("API ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ë°°ì—´ì´ ì•„ë‹˜)");
                    }
                    
                    if (data.length === 0) {
                        document.getElementById("orgChartDiv").innerHTML = `<p style="color: orange; padding: 20px;">**ê²½ê³ :** Google Sheetsì— ë…¸ë“œë¥¼ ìƒì„±í•  **ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.**</p>`;
                        showLoadingSpinner(false);
                        return;
                    }

                    // ìˆ˜ì‹ ëœ ë°ì´í„°ë¥¼ GoJS ëª¨ë¸ í˜•ì‹ì— ë§ê²Œ ê°€ê³µ
                    const newNodeDataArray = data.map(item => ({
                        key: item['ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ'], 
                        parent: item['ìƒìœ„_ë…¸ë“œ_ì§€ê°‘_ì£¼ì†Œ'], 
                        ìœ ì €_ì´ë¦„: item['ìœ ì €_ì´ë¦„'] || item['ìœ ì €_ID'],
                        ìœ ì €_ID: item['ìœ ì €_ID'],
                        ì—°ë½ì²˜: item['ì—°ë½ì²˜'],
                        ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ: item['ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ'],
                        ì§ì†_í•˜ìœ„_ìˆ˜: item['ì§ì†_í•˜ìœ„_ìˆ˜'],
                        ì´_í•˜ìœ„_ìˆ˜: item['ì´_í•˜ìœ„_ìˆ˜'],
                        isRoot: item['ìƒìœ„_ë…¸ë“œ_ì§€ê°‘_ì£¼ì†Œ'] === "", 
                        isHighlighted: false 
                    })).filter(item => item.key); 
                    
                    // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ë° ê²½ê³  í‘œì‹œ
                    const validationError = validateNodeData(newNodeDataArray);
                    if (validationError) {
                        showWarningMessage(validationError);
                    }
                    
                    allNodeData = newNodeDataArray; 
                    
                    // ì„œë¸ŒíŠ¸ë¦¬ ë·° ìƒíƒœì˜€ë‹¤ë©´ ì„œë¸ŒíŠ¸ë¦¬ë¥¼ ìœ ì§€í•˜ë©° ë¹Œë“œ, ì•„ë‹ˆë©´ ì „ì²´ ì¡°ì§ë„ ë¹Œë“œ
                    if (isSubtreeView && currentSubtreeRootKey) {
                        showSubtree(currentSubtreeRootKey); 
                    } else {
                        buildChart(allNodeData, isInitialLoad); 
                    }

                })
                .catch(error => {
                    // API ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ ì¶œë ¥
                    console.error("ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                    document.getElementById("orgChartDiv").innerHTML = `<p style="color: red; padding: 20px;">**ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:** API ì£¼ì†Œë‚˜ Google Apps Script ì„¤ì •(ê³µê°œ ì—¬ë¶€)ì„ í™•ì¸í•˜ì„¸ìš”. ${error.message}</p>`;
                    showLoadingSpinner(false);
                    showWarningMessage(`ì¹˜ëª…ì  API ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
                });
        }

        // ì„ íƒëœ ë…¸ë“œì˜ ìƒì„¸ ì •ë³´ë¥¼ HTML ë°•ìŠ¤ì— í‘œì‹œ
        function showNodeDetails(data) {
            // ë”ë¸” í´ë¦­ ëŒ€ì‹  ë²„íŠ¼ í´ë¦­ì„ ìœ ë„í•˜ê¸° ìœ„í•´ í•˜ìœ„ ì¡°ì§ë§Œ ë³´ê¸° ê¸°ëŠ¥ì€ ë²„íŠ¼ìœ¼ë¡œë§Œ ì œê³µ
            const subtreeButton = data.ì´_í•˜ìœ„_ìˆ˜ > 0 ? 
                `<button onclick="showSubtree('${data.key}')">ğŸ‘‰ í•˜ìœ„ ì¡°ì§ë§Œ ë³´ê¸°</button>` : 
                '';
                
            selectedNodeInfoDiv.innerHTML = `
                <h3>${data.ìœ ì €_ì´ë¦„} (${data.ìœ ì €_ID})</h3>
                <p><strong>ë³¸ì¸ ì§€ê°‘:</strong> ${data.ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ}</p>
                <p><strong>ìƒìœ„ ì§€ê°‘:</strong> ${data.parent || 'ì—†ìŒ (ë£¨íŠ¸)'}</p>
                <p><strong>ì—°ë½ì²˜:</strong> ${data.ì—°ë½ì²˜}</p>
                <p><strong>ì§ì† í•˜ìœ„:</strong> ${data.ì§ì†_í•˜ìœ„_ìˆ˜}ëª…, <strong>ì´ í•˜ìœ„ ì¡°ì§:</strong> ${data.ì´_í•˜ìœ„_ìˆ˜}ëª…</p>
                ${subtreeButton}
            `;
        }
        
        // ê²€ìƒ‰ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ê³  ê²°ê³¼ ë…¸ë“œë¥¼ í•˜ì´ë¼ì´íŠ¸ ë° ì¤‘ì•™ìœ¼ë¡œ ì´ë™
        function highlightNodes() {
            if (!myDiagram || !myDiagram.model) return;
            
            const searchInput = document.getElementById('searchInput');
            const searchText = searchInput.value.toLowerCase().trim();
            const model = myDiagram.model;
            let firstFoundNode = null; 

            myDiagram.startTransaction("highlight search results");

            // ëª¨ë“  ë…¸ë“œë¥¼ ìˆœíšŒí•˜ë©° ê²€ìƒ‰ì–´ ì¼ì¹˜ ì—¬ë¶€ í™•ì¸
            model.nodeDataArray.forEach(data => {
                const name = (data.ìœ ì €_ì´ë¦„ || '').toLowerCase();
                const userId = (data.ìœ ì €_ID || '').toLowerCase();
                const contact = (data.ì—°ë½ì²˜ || '').toLowerCase();
                const wallet = (data.ë³¸ì¸_ì§€ê°‘_ì£¼ì†Œ || '').toLowerCase();
                
                let matches = false;

                if (searchText.length > 0) {
                    if (name.includes(searchText) || userId.includes(searchText) || contact.includes(searchText) || wallet.includes(searchText)) {
                        matches = true;
                    }
                }
                
                // í•˜ì´ë¼ì´íŠ¸ ìƒíƒœ ë³€ê²½
                if (data.isHighlighted !== matches) {
                    model.setDataProperty(data, "isHighlighted", matches);
                }
                
                if (matches && !firstFoundNode) {
                    firstFoundNode = myDiagram.findNodeForKey(data.key);
                }
            });
            
            myDiagram.commitTransaction("highlight search results");
            
            // ì²« ë²ˆì§¸ ê²€ìƒ‰ ê²°ê³¼ ë…¸ë“œë¡œ í™”ë©´ ì´ë™ ë° ìƒì„¸ ì •ë³´ í‘œì‹œ
            if (firstFoundNode) {
                myDiagram.centerPart(firstFoundNode);
                firstFoundNode.isSelected = true; 
                showNodeDetails(firstFoundNode.data); 
                showNodeInfo(); 
            } else {
                myDiagram.clearSelection();
                clearNodeInfo(); 
            }
        }
        
        /* ======================================================= */
        /* [4] GoJS ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”© */
        /* ======================================================= */

        // ì¡°ì§ë„ ì´ˆê¸°í™” ë° í…œí”Œë¦¿ ì •ì˜
        function init() {
            if (typeof go === 'undefined') {
                 document.getElementById("orgChartDiv").innerHTML = `<p style="color: red; padding: 20px;">**ì¹˜ëª…ì  ì˜¤ë¥˜:** ì¡°ì§ë„ ì—”ì§„ ë¡œë”© ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.</p>`;
                 return; 
            }
            
            // ëª¨ë°”ì¼ í™˜ê²½ ì´ˆê¸° UI ì„¤ì •
            if (window.innerWidth <= 600) {
                featureInfoDiv.style.display = 'none';
                selectedNodeInfoDiv.style.display = 'none';
                toggleFeatureButton.style.backgroundColor = '#28a745'; 
            }

            myDiagram =
                $(go.Diagram, "orgChartDiv", 
                {
                    initialAutoScale: go.Diagram.Uniform, // ì´ˆê¸°í™” ì‹œ ì¡°ì§ë„ ì „ì²´ ë³´ê¸°
                    layout: $(go.TreeLayout,             // íŠ¸ë¦¬ êµ¬ì¡° ë ˆì´ì•„ì›ƒ ì‚¬ìš©
                                { angle: 90, nodeSpacing: 20, layerSpacing: 70 }), 
                    "undoManager.isEnabled": true,       // ì‹¤í–‰ ì·¨ì†Œ/ë‹¤ì‹œ ì‹¤í–‰ ê¸°ëŠ¥ í™œì„±í™”
                    "click": function(e) {               // ë°°ê²½ í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ ë° ê¸°ëŠ¥ ì•ˆë‚´ ë°•ìŠ¤ ë‹«ê¸°
                        clearNodeInfo();
                        if (featureInfoDiv.style.display === 'block') {
                            featureInfoDiv.style.display = 'none';
                            toggleFeatureButton.style.backgroundColor = '#28a745'; 
                        }
                    }
                });
            
            // **ë”ë¸” í´ë¦­ ê¸°ëŠ¥ì€ ìš”ì²­ì— ë”°ë¼ ì œê±°í•©ë‹ˆë‹¤.**
            // myDiagram.doubleClick = function(e) {
            //     const node = e.targetObject.part;
            //     if (node instanceof go.Node) {
            //         showSubtree(node.data.key);
            //     }
            // };
            
            // [ë…¸ë“œ ì„ íƒ ì‹œ í‘œì‹œë˜ëŠ” í…Œë‘ë¦¬ ë””ìì¸ í…œí”Œë¦¿]
            const nodeSelectionAdornmentTemplate =
                $(go.Adornment, "Auto",
                    $(go.Shape, "RoundedRectangle",
                        { fill: null, stroke: "dodgerblue", strokeWidth: 3 }),
                    $(go.Placeholder) 
                );

            // [ë…¸ë“œ í…œí”Œë¦¿] ì •ì˜
            myDiagram.nodeTemplate = 
                $(go.Node, "Auto",
                    { selectionAdornmentTemplate: nodeSelectionAdornmentTemplate },
                    // ë…¸ë“œ ìœ„ì¹˜ ë°ì´í„° ë°”ì¸ë”©
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    {
                        // ë…¸ë“œ í´ë¦­ ì‹œ ìƒì„¸ ì •ë³´ í‘œì‹œ
                        click: function(e, node) {
                            showNodeDetails(node.data);
                            showNodeInfo();
                        }
                    },
                    $(go.Shape, "RoundedRectangle",
                        { name: "shapeElement", strokeWidth: 2, stroke: "#224488" },
                        // ë…¸ë“œ ìƒ‰ìƒ ë°”ì¸ë”© (í•˜ì´ë¼ì´íŠ¸, ë£¨íŠ¸, í•˜ìœ„ ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ êµ¬ë¶„)
                        new go.Binding("fill", "isHighlighted", function(h, shape) {
                            if (h) return "#A9A9A9"; 
                            
                            if (shape.part.data.isRoot && !isSubtreeView) return "#ff9933"; 
                            if (shape.part.data.isRoot && isSubtreeView) return "#009688"; 
                            
                            const count = shape.part.data.ì´_í•˜ìœ„_ìˆ˜;
                            
                            if (count >= 70) return "#E91E63";      
                            if (count >= 30) return "#FFC107";      
                            if (count >= 10) return "#00BCD4";      
                            
                            return "#66bb6a";                       
                        })
                    ),
                    
                    $(go.TextBlock, "Default Info",
                        { 
                            margin: 10, 
                            font: "bold 16pt Arial, sans-serif",
                            stroke: "white", 
                            textAlign: "center" 
                        },
                        // ë…¸ë“œ ë‚´ë¶€ í…ìŠ¤íŠ¸ êµ¬ì„± (ì´ë¦„, ID, ì´ í•˜ìœ„ ìˆ˜)
                        new go.Binding("text", "", function(data) {
                            const name = data.ìœ ì €_ì´ë¦„ || 'ì´ë¦„ ì—†ìŒ';
                            const userId = data.ìœ ì €_ID;
                            let totalCountLine = "";
                            if (data.ì´_í•˜ìœ„_ìˆ˜ && data.ì´_í•˜ìœ„_ìˆ˜ > 0) {
                                totalCountLine = `\n(ì´ ${data.ì´_í•˜ìœ„_ìˆ˜}ëª…)`;
                            }
                            return `${name}\n${userId}${totalCountLine}`; 
                        })
                    )
                );

            // [ë§í¬ í…œí”Œë¦¿] ì •ì˜ (ë…¸ë“œ ê°„ ì—°ê²°ì„ )
            myDiagram.linkTemplate = 
                $(go.Link, go.Link.Orthogonal, { corner: 5 }, 
                    $(go.Shape, { strokeWidth: 1.5, stroke: "#555" }));
            
            // API ë°ì´í„° ë¡œë“œ (í˜ì´ì§€ ë¡œë“œ ì‹œ ìµœì´ˆ 1íšŒ)
            fetchDataAndBuildChart(myDiagram, true); 
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
